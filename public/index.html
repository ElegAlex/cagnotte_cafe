<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cagnotte Café</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body {
            background: #fafafa;
            color: #1a1a1a;
        }
        
        .card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        
        .card:hover {
            border-color: #d0d0d0;
        }
        
        .participant-card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            transition: all 0.15s ease;
        }
        
        .participant-card:hover {
            border-color: #a3a3a3;
        }
        
        .participant-positive {
            border-left: 3px solid #22c55e;
        }
        
        .participant-negative {
            border-left: 3px solid #ef4444;
        }
        
        .btn {
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.15s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary {
            background: #1a1a1a;
            color: white;
        }
        
        .btn-primary:hover {
            background: #404040;
        }
        
        .btn-success {
            background: #22c55e;
            color: white;
        }
        
        .btn-success:hover {
            background: #16a34a;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #525252;
            border: 1px solid #e5e5e5;
        }
        
        .btn-secondary:hover {
            background: #e5e5e5;
        }
        
        .input {
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            background: white;
            transition: all 0.15s ease;
            color: #1a1a1a;
        }
        
        .input:focus {
            outline: none;
            border-color: #1a1a1a;
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1);
        }
        
        .input::placeholder {
            color: #a3a3a3;
        }
        
        .status-badge {
            background: #f5f5f5;
            color: #525252;
            font-size: 13px;
            font-weight: 500;
            border-radius: 20px;
            border: 1px solid #e5e5e5;
        }
        
        .status-connected {
            background: #dcfce7;
            color: #166534;
            border-color: #bbf7d0;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border-color: #fecaca;
        }
        
        .balance-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #404040 100%);
            color: white;
        }
        
        .transaction-item {
            background: #f9f9f9;
            border: 1px solid #f0f0f0;
            border-radius: 6px;
            transition: background 0.15s ease;
        }
        
        .transaction-item:hover {
            background: #f5f5f5;
        }
        
        .stock-item {
            background: #f9f9f9;
            border: 1px solid #f0f0f0;
            border-radius: 6px;
        }
        
        .preparation-count {
            background: #fbbf24;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 16px;
        }
        
        .text-muted {
            color: #737373;
        }
        
        .text-success {
            color: #22c55e;
        }
        
        .text-danger {
            color: #ef4444;
        }
        
        .divider {
            border-bottom: 1px solid #f0f0f0;
        }
        
        .loading-dot {
            width: 4px;
            height: 4px;
            background: #a3a3a3;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="border-b border-gray-200 bg-white">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                <div>
                    <h1 class="text-2xl font-semibold text-gray-900">Cagnotte Café</h1>
                    <p class="text-sm text-gray-600 mt-1">Gestion collective des frais café</p>
                </div>
                
                <div id="statusConnexion">
                    <div class="status-badge px-3 py-1.5">
                        <div class="flex items-center gap-2">
                            <div class="loading-dot"></div>
                            <span>Connexion...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-6 py-8">
        
        <!-- Main Content -->
        <div class="grid lg:grid-cols-3 gap-8">
            
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Participants -->
                <div class="card p-6">
                    <h2 class="section-title">Participants</h2>
                    
                    <!-- Add Form -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                        <h3 class="font-medium text-gray-900 mb-3">Ajouter un participant</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <input 
                                type="text" 
                                id="nomParticipant" 
                                placeholder="Nom" 
                                class="input px-3 py-2 text-sm"
                            >
                            <input 
                                type="number" 
                                id="contributionInitiale" 
                                placeholder="Contribution (€)" 
                                step="0.01" 
                                class="input px-3 py-2 text-sm"
                            >
                            <button onclick="ajouterParticipant()" class="btn btn-primary px-4 py-2 text-sm">
                                Ajouter
                            </button>
                        </div>
                    </div>
                    
                    <!-- Participants List -->
                    <div id="listeParticipants">
                        <div class="text-center py-12 text-gray-500">
                            <div class="flex justify-center mb-3">
                                <div class="loading-dot"></div>
                            </div>
                            <p class="text-sm">Chargement...</p>
                        </div>
                    </div>
                </div>

                <!-- Coffee Journal -->
                <div class="card p-6">
                    <h2 class="section-title">Journal des cafés</h2>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                        <select id="preparateurSelect" class="input w-full px-3 py-2 text-sm mb-3">
                            <option value="">Qui a préparé le café ?</option>
                        </select>
                        <button onclick="ajouterPreparation()" class="btn btn-primary w-full px-4 py-2 text-sm">
                            Marquer comme préparé
                        </button>
                    </div>
                    
                    <div>
                        <h3 class="font-medium text-gray-900 mb-3">Préparations récentes</h3>
                        <div id="preparationsJour">
                            <div class="text-center py-8 text-gray-500">
                                <div class="flex justify-center mb-3">
                                    <div class="loading-dot"></div>
                                </div>
                                <p class="text-sm">Chargement...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-8">

                <!-- Balance -->
                <div class="balance-card card p-6">
                    <div class="text-center">
                        <p class="text-sm font-medium text-white/80 mb-2">Solde actuel</p>
                        <div id="solde" class="text-4xl font-bold text-white">0.00 €</div>
                    </div>
                </div>
                
                <!-- Expenses -->
                <div class="card p-6">
                    <h2 class="section-title">Nouvelle dépense</h2>
                    
                    <div class="space-y-3">
                        <input 
                            type="text" 
                            id="descriptionDepense" 
                            placeholder="Description" 
                            class="input w-full px-3 py-2 text-sm"
                        >
                        <input 
                            type="number" 
                            id="montantDepense" 
                            placeholder="Montant (€)" 
                            step="0.01" 
                            class="input w-full px-3 py-2 text-sm"
                        >
                        <button onclick="ajouterDepense()" class="btn btn-danger w-full px-4 py-2 text-sm">
                            Enregistrer la dépense
                        </button>
                    </div>
                </div>

                <!-- Stock -->
                <div class="card p-6">
                    <h2 class="section-title">Stock</h2>
                    
                    <div class="space-y-3">
                        <div class="stock-item p-3">
                            <div class="flex flex-wrap items-center justify-between gap-2">
                                <span class="text-sm font-medium text-gray-900">Paquets de café</span>
                                <div class="flex items-center gap-2">
                                    <button onclick="modifierStock('cafe', -1)" class="btn btn-secondary w-8 h-8 text-xs">-</button>
                                    <span id="stockCafe" class="font-medium text-sm min-w-[2rem] text-center">0</span>
                                    <button onclick="modifierStock('cafe', 1)" class="btn btn-secondary w-8 h-8 text-xs">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stock-item p-3">
                            <div class="flex flex-wrap items-center justify-between gap-2">
                                <span class="text-sm font-medium text-gray-900">Filtres</span>
                                <div class="flex items-center gap-2">
                                    <button onclick="modifierStock('filtres', -1)" class="btn btn-secondary w-8 h-8 text-xs">-</button>
                                    <span id="stockFiltres" class="font-medium text-sm min-w-[2rem] text-center">0</span>
                                    <button onclick="modifierStock('filtres', 1)" class="btn btn-secondary w-8 h-8 text-xs">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History -->
                <div class="card p-6">
                    <h2 class="section-title">Historique</h2>
                    
                    <div id="historiqueTransactions" class="space-y-2 max-h-80 overflow-y-auto">
                        <div class="text-center py-8 text-gray-500">
                            <div class="flex justify-center mb-3">
                                <div class="loading-dot"></div>
                            </div>
                            <p class="text-sm">Chargement...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            orderBy,
            query,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCZi2ttG9mf_87p_Cwph5cZNtJqc7sFuoY",
            authDomain: "cagnotte-cafe.firebaseapp.com",
            projectId: "cagnotte-cafe",
            storageBucket: "cagnotte-cafe.firebasestorage.app",
            messagingSenderId: "99343324135",
            appId: "1:99343324135:web:2f7f17b929daf9579f6342",
            measurementId: "G-KPTKK1XT9C"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables globales
        let participants = [];
        let transactions = [];
        let preparations = [];
        let stock = { cafe: 0, filtres: 0 };

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // === STATUT CONNEXION ===
        function mettreAJourStatutConnexion(statut) {
            const statusElement = document.getElementById('statusConnexion');
            const statuts = {
                'connexion': { 
                    html: '<div class="flex items-center gap-2"><div class="loading-dot"></div><span>Connexion...</span></div>', 
                    class: 'status-badge px-3 py-1.5' 
                },
                'connecte': { 
                    html: '<div class="flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div><span>Synchronisé</span></div>', 
                    class: 'status-connected px-3 py-1.5' 
                },
                'erreur': { 
                    html: '<div class="flex items-center gap-2"><div class="w-2 h-2 bg-red-500 rounded-full"></div><span>Erreur</span></div>', 
                    class: 'status-error px-3 py-1.5' 
                }
            };
            
            const config = statuts[statut] || statuts['erreur'];
            statusElement.innerHTML = `<div class="${config.class}">${config.html}</div>`;
        }

        // === FIREBASE FONCTIONS ===
        async function chargerDonnees() {
            try {
                mettreAJourStatutConnexion('connexion');
                
                // Charger participants
                const participantsSnapshot = await getDocs(collection(db, 'participants'));
                participants = participantsSnapshot.docs
                    .map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            avatar: data.avatar || '🙂',
                            totalContribue: data.totalContribue || 0,
                            preparationsCompte: data.preparationsCompte || 0,
                            cafesBus: data.cafesBus || 0,
                            contributions: data.contributions || []
                        };
                    })
                    .filter(p => p.nom && p.nom !== 'undefined' && p.nom.trim() !== '');

                // Charger transactions
                const transactionsSnapshot = await getDocs(query(collection(db, 'transactions'), orderBy('timestamp', 'desc')));
                transactions = transactionsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Charger préparations
                const preparationsSnapshot = await getDocs(query(collection(db, 'preparations'), orderBy('timestamp', 'desc')));
                preparations = preparationsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Charger stock
                const stockSnapshot = await getDocs(collection(db, 'stock'));
                if (!stockSnapshot.empty) {
                    const stockDoc = stockSnapshot.docs[0];
                    stock = stockDoc.data();
                }

                mettreAJourStatutConnexion('connecte');
                mettreAJourInterface();
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                mettreAJourStatutConnexion('erreur');
            }
        }

        // === FONCTIONS DE NETTOYAGE ===
        window.nettoyageUrgence = async function() {
            if (!confirm('Supprimer tous les participants avec des noms invalides ?')) {
                return;
            }
            
            try {
                mettreAJourStatutConnexion('connexion');
                
                const participantsSnapshot = await getDocs(collection(db, 'participants'));
                const suppressions = [];
                
                participantsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (!data.nom || data.nom === 'undefined' || data.nom.trim() === '') {
                        suppressions.push(deleteDoc(doc.ref));
                    }
                });
                
                if (suppressions.length > 0) {
                    await Promise.all(suppressions);
                    alert(`${suppressions.length} participants invalides supprimés`);
                } else {
                    alert('Aucun participant invalide trouvé');
                }
                
                mettreAJourStatutConnexion('connecte');
            } catch (error) {
                console.error('Erreur nettoyage:', error);
                alert('Erreur lors du nettoyage');
                mettreAJourStatutConnexion('erreur');
            }
        };

        // === FONCTIONS PARTICIPANTS ===
        window.ajouterParticipant = async function() {
            const nom = document.getElementById('nomParticipant').value.trim();
            const contribution = parseFloat(document.getElementById('contributionInitiale').value) || 0;
            
            if (!nom || nom === 'undefined') {
                alert('Veuillez entrer un nom valide');
                return;
            }
            
            if (participants.find(p => p.nom && p.nom.toLowerCase() === nom.toLowerCase())) {
                alert('Ce participant existe déjà');
                return;
            }
            
            try {
                const participant = {
                    nom: nom,
                    avatar: '🙂',
                    contributions: contribution > 0 ? [{ montant: contribution, date: new Date().toISOString() }] : [],
                    preparationsCompte: 0,
                    cafesBus: 0,
                    totalContribue: contribution,
                    dateCreation: new Date().toISOString(),
                    timestamp: serverTimestamp()
                };
                
                const docRef = await addDoc(collection(db, 'participants'), participant);
                
                if (contribution > 0) {
                    await ajouterTransaction(`Contribution de ${nom}`, contribution, 'contribution', nom);
                }
                
                document.getElementById('nomParticipant').value = '';
                document.getElementById('contributionInitiale').value = '';
                
            } catch (error) {
                console.error('Erreur ajout participant:', error);
                alert('Erreur lors de l\'ajout du participant');
            }
        };

        window.ajouterContributionParticipant = async function(participantId, montant) {
            const montantFloat = parseFloat(montant);
            if (!montantFloat || montantFloat === 0) {
                return;
            }
            
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;
            
            try {
                const contribution = {
                    montant: montantFloat,
                    date: new Date().toISOString()
                };
                
                const nouvellesContributions = [...(participant.contributions || []), contribution];
                const nouveauTotal = (participant.totalContribue || 0) + contribution.montant;
                
                await updateDoc(doc(db, 'participants', participantId), {
                    contributions: nouvellesContributions,
                    totalContribue: nouveauTotal
                });
                
                await ajouterTransaction(`Contribution de ${participant.nom}`, contribution.montant, 'contribution', participant.nom);
            } catch (error) {
                console.error('Erreur:', error);
            }
        };

        window.retirerContributionParticipant = async function(participantId, montant) {
            const montantFloat = parseFloat(montant);
            if (!montantFloat || montantFloat === 0) {
                return;
            }
            
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;
            
            try {
                const retrait = {
                    montant: -montantFloat,
                    date: new Date().toISOString()
                };
                
                const nouvellesContributions = [...(participant.contributions || []), retrait];
                const nouveauTotal = (participant.totalContribue || 0) - montantFloat;
                
                await updateDoc(doc(db, 'participants', participantId), {
                    contributions: nouvellesContributions,
                    totalContribue: nouveauTotal
                });
                
                await ajouterTransaction(`Retrait de ${participant.nom}`, montantFloat, 'retrait', participant.nom);
            } catch (error) {
                console.error('Erreur:', error);
            }
        };

        window.incrementerCafeBu = async function(participantId) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;
            try {
                await updateDoc(doc(db, 'participants', participantId), {
                    cafesBus: (participant.cafesBus || 0) + 1
                });
                mettreAJourInterface();
            } catch (error) {
                console.error('Erreur:', error);
            }
        };

        window.changerAvatarParticipant = async function(participantId, avatar) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant || participant.avatar === avatar) return;
            try {
                await updateDoc(doc(db, 'participants', participantId), {
                    avatar: avatar
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        };

        // === FONCTIONS DÉPENSES ===
        window.ajouterDepense = async function() {
            const description = document.getElementById('descriptionDepense').value.trim();
            const montant = parseFloat(document.getElementById('montantDepense').value) || 0;
            
            if (!description || montant <= 0) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            try {
                await ajouterTransaction(description, montant, 'depense');
                
                document.getElementById('descriptionDepense').value = '';
                document.getElementById('montantDepense').value = '';
                
            } catch (error) {
                console.error('Erreur:', error);
            }
        };

        // === FONCTIONS PRÉPARATIONS ===
        window.ajouterPreparation = async function() {
            const selecteur = document.getElementById('preparateurSelect');
            const participantNom = selecteur.value;
            
            if (!participantNom) {
                alert('Veuillez sélectionner qui a préparé le café');
                return;
            }
            
            try {
                const participant = participants.find(p => p.nom === participantNom);
                if (participant) {
                    await updateDoc(doc(db, 'participants', participant.id), {
                        preparationsCompte: (participant.preparationsCompte || 0) + 1
                    });
                }
                
                const preparation = {
                    preparateur: participantNom,
                    date: new Date().toLocaleDateString('fr-FR'),
                    heure: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                    timestamp: serverTimestamp()
                };
                
                await addDoc(collection(db, 'preparations'), preparation);
                
                selecteur.value = '';
                
            } catch (error) {
                console.error('Erreur:', error);
            }
        };

        // === FONCTIONS STOCK ===
        window.modifierStock = async function(type, quantite) {
            try {
                const nouveauStock = {
                    ...stock,
                    [type]: Math.max(0, (stock[type] || 0) + quantite)
                };
                
                const stockSnapshot = await getDocs(collection(db, 'stock'));
                if (stockSnapshot.empty) {
                    await addDoc(collection(db, 'stock'), nouveauStock);
                } else {
                    const stockDoc = stockSnapshot.docs[0];
                    await updateDoc(stockDoc.ref, nouveauStock);
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        };

        // === FONCTIONS TRANSACTIONS ===
        async function ajouterTransaction(description, montant, type, participant = null) {
            const transaction = {
                description: description,
                montant: montant,
                type: type,
                participant: participant,
                date: new Date().toLocaleDateString('fr-FR'),
                heure: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                timestamp: serverTimestamp()
            };
            
            await addDoc(collection(db, 'transactions'), transaction);
        }

        // === AFFICHAGE ===
        function calculerSolde() {
            return transactions.reduce((total, transaction) => {
                switch(transaction.type) {
                    case 'contribution':
                        return total + transaction.montant;
                    case 'depense':
                    case 'retrait':
                        return total - transaction.montant;
                    default:
                        return total;
                }
            }, 0);
        }

        function mettreAJourInterface() {
            // Solde
            const solde = calculerSolde();
            const soldeElement = document.getElementById('solde');
            if (soldeElement) {
                soldeElement.textContent = `${solde.toFixed(2)} €`;
            }
            
            afficherParticipants();
            afficherHistoriqueTransactions();
            afficherPreparations();
            afficherStock();
            mettreAJourSelecteurPreparateur();
        }

        function afficherParticipants() {
            const container = document.getElementById('listeParticipants');
            if (!container) return;
            
            if (participants.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-sm">Aucun participant</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = participants.map(p => `
                <div class="participant-card ${(p.totalContribue || 0) >= 0 ? 'participant-positive' : 'participant-negative'} p-4 mb-3">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mb-3">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900 flex items-center gap-2">
                                ${escapeHtml(p.nom)}
                                <span class="text-xs text-muted">${p.cafesBus || 0} ☕</span>
                            </h4>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-sm ${(p.totalContribue || 0) >= 0 ? 'text-success' : 'text-danger'} font-medium">
                                    ${(p.totalContribue || 0).toFixed(2)}€
                                </span>
                                ${(p.preparationsCompte || 0) > 0 ? `<span class="preparation-count">${p.preparationsCompte || 0} 🫖</span>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="text-xl">${escapeHtml(p.avatar || '🙂')}</div>
                            <select onchange="changerAvatarParticipant('${p.id}', this.value)" class="input px-1 py-0.5 text-xs mt-1">
                                <option value="🙂" ${p.avatar === '🙂' ? 'selected' : ''}>🙂</option>
                                <option value="😀" ${p.avatar === '😀' ? 'selected' : ''}>😀</option>
                                <option value="😎" ${p.avatar === '😎' ? 'selected' : ''}>😎</option>
                                <option value="😃" ${p.avatar === '😃' ? 'selected' : ''}>😃</option>
                                <option value="☕" ${p.avatar === '☕' ? 'selected' : ''}>☕</option>
                                <option value="🦁" ${p.avatar === '🦁' ? 'selected' : ''}>🦁</option>
                                <option value="🦄" ${p.avatar === '🦄' ? 'selected' : ''}>🦄</option>
                                <option value="🐱" ${p.avatar === '🐱' ? 'selected' : ''}>🐱</option>
                                <option value="🐶" ${p.avatar === '🐶' ? 'selected' : ''}>🐶</option>
                                <option value="😇" ${p.avatar === '😇' ? 'selected' : ''}>😇</option>
                                <option value="🤠" ${p.avatar === '🤠' ? 'selected' : ''}>🤠</option>
                                <option value="🥳" ${p.avatar === '🥳' ? 'selected' : ''}>🥳</option>
                                <option value="🦊" ${p.avatar === '🦊' ? 'selected' : ''}>🦊</option>
                                <option value="🐵" ${p.avatar === '🐵' ? 'selected' : ''}>🐵</option>
                                <option value="😜" ${p.avatar === '😜' ? 'selected' : ''}>😜</option>
                                <option value="😺" ${p.avatar === '😺' ? 'selected' : ''}>😺</option>
                                <option value="🙈" ${p.avatar === '🙈' ? 'selected' : ''}>🙈</option>
                                <option value="🤖" ${p.avatar === '🤖' ? 'selected' : ''}>🤖</option>
                                <option value="🐔" ${p.avatar === '🐔' ? 'selected' : ''}>🐔</option>
                                <option value="🐢" ${p.avatar === '🐢' ? 'selected' : ''}>🐢</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        <input type="number"
                               id="contrib-${p.id}"
                               placeholder="Montant"
                               step="0.01"
                               class="input flex-1 px-2 py-1 text-sm">
                        <button onclick="ajouterContributionParticipant('${p.id}', document.getElementById('contrib-${p.id}').value); document.getElementById('contrib-${p.id}').value=''" 
                                class="btn btn-success px-3 py-1 text-xs">
                            +
                        </button>
                        <button onclick="retirerContributionParticipant('${p.id}', document.getElementById('contrib-${p.id}').value); document.getElementById('contrib-${p.id}').value=''"
                                class="btn btn-danger px-3 py-1 text-xs">
                            −
                        </button>
                        <button onclick="incrementerCafeBu('${p.id}')" class="btn btn-secondary px-3 py-1 text-xs">☕</button>
                    </div>
                </div>
            `).join('');
        }

        function afficherHistoriqueTransactions() {
            const container = document.getElementById('historiqueTransactions');
            if (!container) return;
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-sm">Aucune transaction</p>
                    </div>
                `;
                return;
            }
            
            const transactionsRecentes = transactions.slice(0, 10);
            
            container.innerHTML = transactionsRecentes.map(t => {
                const typeIcon = {
                    'contribution': '↗',
                    'depense': '↙',
                    'retrait': '↙'
                }[t.type] || '↙';
                
                const typeColor = {
                    'contribution': 'text-success',
                    'depense': 'text-danger',
                    'retrait': 'text-danger'
                }[t.type] || 'text-danger';
                
                return `
                    <div class="transaction-item p-3">
                        <div class="flex flex-wrap items-center justify-between gap-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs ${typeColor}">${typeIcon}</span>
                                    <span class="text-sm font-medium text-gray-900 truncate">${escapeHtml(t.description)}</span>
                                </div>
                                ${t.participant ? `<p class="text-xs text-muted">par ${escapeHtml(t.participant)}</p>` : ''}
                                <p class="text-xs text-muted">${escapeHtml(t.date)} ${escapeHtml(t.heure)}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium ${typeColor}">
                                    ${t.type === 'contribution' ? '+' : '−'}${t.montant.toFixed(2)}€
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function afficherPreparations() {
            const container = document.getElementById('preparationsJour');
            if (!container) return;
            
            if (preparations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-sm">Aucune préparation</p>
                    </div>
                `;
                return;
            }
            
            // Grouper par jour
            const preparationsParJour = {};
            preparations.forEach(prep => {
                if (!preparationsParJour[prep.date]) {
                    preparationsParJour[prep.date] = [];
                }
                preparationsParJour[prep.date].push(prep);
            });
            
            const jours = Object.keys(preparationsParJour).sort().reverse().slice(0, 5);
            
            container.innerHTML = jours.map(jour => {
                const prepsJour = preparationsParJour[jour];
                return `
                    <div class="transaction-item p-3 mb-2">
                        <h5 class="text-sm font-medium text-gray-900 mb-1">${jour}</h5>
                        <div class="text-xs text-muted">
                            ${prepsJour.length} café${prepsJour.length > 1 ? 's' : ''}
                        </div>
                        <div class="text-xs text-muted mt-1">
                            ${prepsJour.slice(-3).map(p => `${escapeHtml(p.heure)} ${escapeHtml(p.preparateur)}`).join(' • ')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function afficherStock() {
            const cafeElement = document.getElementById('stockCafe');
            const filtresElement = document.getElementById('stockFiltres');
            
            if (cafeElement) cafeElement.textContent = stock.cafe || 0;
            if (filtresElement) filtresElement.textContent = stock.filtres || 0;
        }

        function mettreAJourSelecteurPreparateur() {
            const selecteur = document.getElementById('preparateurSelect');
            if (!selecteur) return;
            
            selecteur.innerHTML = '<option value="">Qui a préparé le café ?</option>' +
                participants.map(p => `<option value="${escapeHtml(p.nom)}">${escapeHtml(p.nom)}</option>`).join('');
        }

        // === ÉCOUTE EN TEMPS RÉEL ===
        function configurerEcouteTempsReel() {
            // Écouter les participants
            onSnapshot(collection(db, 'participants'), (snapshot) => {
                participants = snapshot.docs
                    .map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            avatar: data.avatar || '🙂',
                            totalContribue: data.totalContribue || 0,
                            preparationsCompte: data.preparationsCompte || 0,
                            cafesBus: data.cafesBus || 0,
                            contributions: data.contributions || []
                        };
                    })
                    .filter(p => p.nom && p.nom !== 'undefined' && p.nom.trim() !== '');
                mettreAJourInterface();
            });

            // Écouter les transactions
            onSnapshot(query(collection(db, 'transactions'), orderBy('timestamp', 'desc')), (snapshot) => {
                transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                mettreAJourInterface();
            });

            // Écouter les préparations
            onSnapshot(query(collection(db, 'preparations'), orderBy('timestamp', 'desc')), (snapshot) => {
                preparations = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                mettreAJourInterface();
            });

            // Écouter le stock
            onSnapshot(collection(db, 'stock'), (snapshot) => {
                if (!snapshot.empty) {
                    stock = snapshot.docs[0].data();
                    afficherStock();
                }
            });
        }

        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', function() {
            chargerDonnees().then(() => {
                configurerEcouteTempsReel();
            });
        });
    </script>
</body>
</html>
