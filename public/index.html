<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Cagnotte du Caf√© ‚òï</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles custom pour votre design original */
        .participant-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
            padding: 16px;
            margin: 8px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .emoji-large {
            font-size: 2rem;
        }
        
        .counter-individual {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .negative-contrib {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }
        
        .positive-contrib {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }
        
        .preparation-counter {
            display: inline-block;
            background: #ffd43b;
            color: #333;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">‚òï La Cagnotte du Caf√©</h1>
            <p class="text-gray-600">G√©rez votre caf√© d'√©quipe facilement</p>
            <div id="statusConnexion" class="mt-2">
                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">
                    üîÑ Connexion en cours...
                </span>
            </div>
        </header>

        <!-- Solde Principal -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 text-center">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Solde Actuel de la Cagnotte</h2>
            <div id="solde" class="text-5xl font-bold text-green-600">0.00 ‚Ç¨</div>
        </div>

        <!-- Bouton NETTOYAGE D'URGENCE -->
        <div class="text-center mb-4">
            <button onclick="nettoyageUrgence()" 
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 mr-4">
                üßπ NETTOYAGE D'URGENCE
            </button>
            <small class="text-gray-500">Supprime les donn√©es corrompues</small>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
            
            <!-- Participants Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">üë• Participants</h3>
                    
                    <!-- Ajouter un participant -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold mb-3">Ajouter un Participant</h4>
                        <div class="flex gap-3">
                            <input type="text" id="nomParticipant" placeholder="Nom du participant" 
                                   class="flex-1 p-3 border border-gray-300 rounded-lg">
                            <input type="number" id="contributionInitiale" placeholder="Contribution (‚Ç¨)" step="0.01" 
                                   class="w-32 p-3 border border-gray-300 rounded-lg">
                            <button onclick="ajouterParticipant()" 
                                    class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                ‚ûï Ajouter
                            </button>
                        </div>
                    </div>
                    
                    <!-- Liste des participants -->
                    <div id="listeParticipants">
                        <div class="loading">üîÑ Chargement des participants...</div>
                    </div>
                </div>

                <!-- Journal des Caf√©s Pr√©par√©s -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">‚òï Journal des Caf√©s Pr√©par√©s</h3>
                    <div class="mb-4">
                        <select id="preparateurSelect" class="w-full p-3 border border-gray-300 rounded-lg mb-3">
                            <option value="">Qui a pr√©par√© le caf√© ?</option>
                        </select>
                        <button onclick="ajouterPreparation()" 
                                class="w-full py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                            ‚òï Marquer comme pr√©par√©
                        </button>
                    </div>
                    
                    <!-- Pr√©parations par jour -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold mb-3">Pr√©parations par Jour</h4>
                        <div id="preparationsJour">
                            <div class="loading">üîÑ Chargement...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar droite -->
            <div class="space-y-6">
                
                <!-- Enregistrer une D√©pense -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üí∞ Enregistrer une D√©pense</h3>
                    <div class="space-y-3">
                        <input type="text" id="descriptionDepense" placeholder="Description (ex: Caf√©, Lait...)" 
                               class="w-full p-3 border border-gray-300 rounded-lg">
                        <input type="number" id="montantDepense" placeholder="Montant (‚Ç¨)" step="0.01" 
                               class="w-full p-3 border border-gray-300 rounded-lg">
                        <button onclick="ajouterDepense()" 
                                class="w-full py-3 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            üí∏ Enregistrer
                        </button>
                    </div>
                </div>

                <!-- Stock de Fournitures -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üì¶ Stock de Fournitures</h3>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span>‚òï Sacs de caf√©</span>
                            <div class="flex items-center gap-2">
                                <button onclick="modifierStock('cafe', -1)" class="px-3 py-1 bg-red-500 text-white rounded">-</button>
                                <span id="stockCafe" class="font-bold min-w-[2rem] text-center">0</span>
                                <button onclick="modifierStock('cafe', 1)" class="px-3 py-1 bg-green-500 text-white rounded">+</button>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span>üîç Bo√Ætes de filtres</span>
                            <div class="flex items-center gap-2">
                                <button onclick="modifierStock('filtres', -1)" class="px-3 py-1 bg-red-500 text-white rounded">-</button>
                                <span id="stockFiltres" class="font-bold min-w-[2rem] text-center">0</span>
                                <button onclick="modifierStock('filtres', 1)" class="px-3 py-1 bg-green-500 text-white rounded">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Historique -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üìú Historique des Transactions</h3>
                    <div id="historiqueTransactions" class="max-h-64 overflow-y-auto">
                        <div class="loading">üîÑ Chargement...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            orderBy,
            query,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configuration Firebase avec VOS vraies cl√©s
        const firebaseConfig = {
            apiKey: "AIzaSyCZi2ttG9mf_87p_Cwph5cZNtJqc7sFuoY",
            authDomain: "cagnotte-cafe.firebaseapp.com",
            projectId: "cagnotte-cafe",
            storageBucket: "cagnotte-cafe.firebasestorage.app",
            messagingSenderId: "99343324135",
            appId: "1:99343324135:web:2f7f17b929daf9579f6342",
            measurementId: "G-KPTKK1XT9C"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables globales
        let participants = [];
        let transactions = [];
        let preparations = [];
        let stock = { cafe: 0, filtres: 0 };

        // === STATUT CONNEXION ===
        function mettreAJourStatutConnexion(statut) {
            const statusElement = document.getElementById('statusConnexion');
            const statuts = {
                'connexion': { text: 'üîÑ Connexion en cours...', class: 'bg-yellow-100 text-yellow-800' },
                'connecte': { text: '‚úÖ Connect√© - √âquipe synchronis√©e', class: 'bg-green-100 text-green-800' },
                'erreur': { text: '‚ùå Erreur de connexion', class: 'bg-red-100 text-red-800' }
            };
            
            const config = statuts[statut] || statuts['erreur'];
            statusElement.innerHTML = `<span class="px-3 py-1 ${config.class} rounded-full text-sm">${config.text}</span>`;
        }

        // === FIREBASE FONCTIONS ===
        async function chargerDonnees() {
            try {
                mettreAJourStatutConnexion('connexion');
                
                // Charger participants (avec filtre pour √©viter les donn√©es corrompues)
                const participantsSnapshot = await getDocs(collection(db, 'participants'));
                participants = participantsSnapshot.docs
                    .map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            totalContribue: data.totalContribue || 0,
                            preparationsCompte: data.preparationsCompte || 0,
                            contributions: data.contributions || []
                        };
                    })
                    .filter(p => p.nom && p.nom !== 'undefined' && p.nom.trim() !== ''); // Filtrer les donn√©es invalides

                // Charger transactions
                const transactionsSnapshot = await getDocs(query(collection(db, 'transactions'), orderBy('timestamp', 'desc')));
                transactions = transactionsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Charger pr√©parations
                const preparationsSnapshot = await getDocs(query(collection(db, 'preparations'), orderBy('timestamp', 'desc')));
                preparations = preparationsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Charger stock
                const stockSnapshot = await getDocs(collection(db, 'stock'));
                if (!stockSnapshot.empty) {
                    const stockDoc = stockSnapshot.docs[0];
                    stock = stockDoc.data();
                }

                mettreAJourStatutConnexion('connecte');
                mettreAJourInterface();
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                mettreAJourStatutConnexion('erreur');
            }
        }

        // === FONCTIONS DE NETTOYAGE ===
        window.nettoyageUrgence = async function() {
            if (!confirm('‚ö†Ô∏è ATTENTION ! Cela va supprimer TOUS les participants avec des noms invalides (undefined, vides). Continuer ?')) {
                return;
            }
            
            try {
                mettreAJourStatutConnexion('connexion');
                
                // Supprimer tous les participants invalides
                const participantsSnapshot = await getDocs(collection(db, 'participants'));
                const suppressions = [];
                
                participantsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (!data.nom || data.nom === 'undefined' || data.nom.trim() === '') {
                        suppressions.push(deleteDoc(doc.ref));
                    }
                });
                
                if (suppressions.length > 0) {
                    await Promise.all(suppressions);
                    alert(`‚úÖ ${suppressions.length} participants invalides supprim√©s !`);
                } else {
                    alert('‚úÖ Aucun participant invalide trouv√© !');
                }
                
                mettreAJourStatutConnexion('connecte');
            } catch (error) {
                console.error('Erreur nettoyage:', error);
                alert('‚ùå Erreur lors du nettoyage: ' + error.message);
                mettreAJourStatutConnexion('erreur');
            }
        };

        // === FONCTIONS PARTICIPANTS ===
        window.ajouterParticipant = async function() {
            const nom = document.getElementById('nomParticipant').value.trim();
            const contribution = parseFloat(document.getElementById('contributionInitiale').value) || 0;
            
            if (nom === '' || nom === 'undefined' || !nom) {
                alert('‚ùå Veuillez entrer un nom valide');
                return;
            }
            
            // V√©rifier si le participant existe d√©j√†
            if (participants.find(p => p.nom && p.nom.toLowerCase() === nom.toLowerCase())) {
                alert('‚ùå Ce participant existe d√©j√† !');
                return;
            }
            
            try {
                const participant = {
                    nom: nom,
                    contributions: contribution > 0 ? [{ montant: contribution, date: new Date().toISOString() }] : [],
                    preparationsCompte: 0,
                    totalContribue: contribution,
                    dateCreation: new Date().toISOString(),
                    timestamp: serverTimestamp()
                };
                
                console.log('Ajout participant:', participant);
                
                const docRef = await addDoc(collection(db, 'participants'), participant);
                console.log('Participant ajout√© avec ID:', docRef.id);
                
                if (contribution > 0) {
                    await ajouterTransaction(`üí∞ Contribution de ${nom}`, contribution, 'contribution', nom);
                }
                
                document.getElementById('nomParticipant').value = '';
                document.getElementById('contributionInitiale').value = '';
                
                alert(`‚úÖ ${nom} ajout√© avec succ√®s !`);
            } catch (error) {
                console.error('Erreur ajout participant:', error);
                alert('‚ùå Erreur lors de l\'ajout du participant: ' + error.message);
            }
        };

        window.ajouterContributionParticipant = async function(participantId, montant) {
            const montantFloat = parseFloat(montant);
            if (!montantFloat || montantFloat === 0) {
                alert('‚ùå Veuillez entrer un montant valide');
                return;
            }
            
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;
            
            try {
                const contribution = {
                    montant: montantFloat,
                    date: new Date().toISOString()
                };
                
                const nouvellesContributions = [...(participant.contributions || []), contribution];
                const nouveauTotal = participant.totalContribue + montantFloat;
                
                await updateDoc(doc(db, 'participants', participantId), {
                    contributions: nouvellesContributions,
                    totalContribue: nouveauTotal
                });
                
                await ajouterTransaction(`üí∞ Contribution de ${participant.nom}`, montantFloat, 'contribution', participant.nom);
                await chargerDonnees();
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de l\'ajout de la contribution');
            }
        };

        window.retirerContributionParticipant = async function(participantId, montant) {
            const montantFloat = parseFloat(montant);
            if (!montantFloat || montantFloat === 0) {
                alert('‚ùå Veuillez entrer un montant valide');
                return;
            }
            
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;
            
            try {
                const retrait = {
                    montant: -montantFloat,
                    date: new Date().toISOString()
                };
                
                const nouvellesContributions = [...(participant.contributions || []), retrait];
                const nouveauTotal = (participant.totalContribue || 0) - montantFloat;
                
                await updateDoc(doc(db, 'participants', participantId), {
                    contributions: nouvellesContributions,
                    totalContribue: nouveauTotal
                });
                
                await ajouterTransaction(`‚ùå Retrait de ${participant.nom}`, montantFloat, 'retrait', participant.nom);
                await chargerDonnees();
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors du retrait');
            }
        };

        // === FONCTIONS D√âPENSES ===
        window.ajouterDepense = async function() {
            const description = document.getElementById('descriptionDepense').value.trim();
            const montant = parseFloat(document.getElementById('montantDepense').value) || 0;
            
            if (description === '' || montant <= 0) {
                alert('‚ùå Veuillez remplir tous les champs correctement');
                return;
            }
            
            try {
                await ajouterTransaction(description, montant, 'depense');
                
                document.getElementById('descriptionDepense').value = '';
                document.getElementById('montantDepense').value = '';
                
                alert('‚úÖ D√©pense enregistr√©e !');
                await chargerDonnees();
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de l\'ajout de la d√©pense');
            }
        };

        // === FONCTIONS PR√âPARATIONS ===
        window.ajouterPreparation = async function() {
            const selecteur = document.getElementById('preparateurSelect');
            const participantNom = selecteur.value;
            
            if (!participantNom) {
                alert('‚ùå Veuillez s√©lectionner qui a pr√©par√© le caf√©');
                return;
            }
            
            try {
                const participant = participants.find(p => p.nom === participantNom);
                if (participant) {
                    await updateDoc(doc(db, 'participants', participant.id), {
                        preparationsCompte: (participant.preparationsCompte || 0) + 1
                    });
                }
                
                const preparation = {
                    preparateur: participantNom,
                    date: new Date().toLocaleDateString('fr-FR'),
                    heure: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                    timestamp: serverTimestamp()
                };
                
                await addDoc(collection(db, 'preparations'), preparation);
                
                selecteur.value = '';
                alert(`‚òï ${participantNom} a pr√©par√© un caf√© !`);
                await chargerDonnees();
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de l\'ajout de la pr√©paration');
            }
        };

        // === FONCTIONS STOCK ===
        window.modifierStock = async function(type, quantite) {
            try {
                const nouveauStock = {
                    ...stock,
                    [type]: Math.max(0, (stock[type] || 0) + quantite)
                };
                
                // Mettre √† jour ou cr√©er le document stock
                const stockSnapshot = await getDocs(collection(db, 'stock'));
                if (stockSnapshot.empty) {
                    await addDoc(collection(db, 'stock'), nouveauStock);
                } else {
                    const stockDoc = stockSnapshot.docs[0];
                    await updateDoc(stockDoc.ref, nouveauStock);
                }
                
                await chargerDonnees();
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la modification du stock');
            }
        };

        // === FONCTIONS TRANSACTIONS ===
        async function ajouterTransaction(description, montant, type, participant = null) {
            const transaction = {
                description: description,
                montant: montant,
                type: type,
                participant: participant,
                date: new Date().toLocaleDateString('fr-FR'),
                heure: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                timestamp: serverTimestamp()
            };
            
            await addDoc(collection(db, 'transactions'), transaction);
        }

        // === AFFICHAGE ===
        function calculerSolde() {
            return transactions.reduce((total, transaction) => {
                switch(transaction.type) {
                    case 'contribution':
                        return total + transaction.montant;
                    case 'depense':
                    case 'retrait':
                        return total - transaction.montant;
                    default:
                        return total;
                }
            }, 0);
        }

        function mettreAJourInterface() {
            // Solde
            const solde = calculerSolde();
            const soldeElement = document.getElementById('solde');
            if (soldeElement) {
                soldeElement.textContent = `${solde.toFixed(2)} ‚Ç¨`;
                soldeElement.className = `text-5xl font-bold ${solde >= 0 ? 'text-green-600' : 'text-red-600'}`;
            }
            
            afficherParticipants();
            afficherHistoriqueTransactions();
            afficherPreparations();
            afficherStock();
            mettreAJourSelecteurPreparateur();
        }

        function afficherParticipants() {
            const container = document.getElementById('listeParticipants');
            if (!container) return;
            
            if (participants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun participant pour le moment.</p>';
                return;
            }
            
            container.innerHTML = participants.map(p => `
                <div class="participant-card ${(p.totalContribue || 0) >= 0 ? 'positive-contrib' : 'negative-contrib'}">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-lg">${p.nom}</h4>
                            <p class="text-sm opacity-90">
                                Total: ${p.totalContribue.toFixed(2)}‚Ç¨
                                <span class="preparation-counter">‚òï ${p.preparationsCompte || 0}</span>
                            </p>
                        </div>
                        <div class="text-3xl">
                            ${p.totalContribue >= 0 ? 'üòä' : 'üò∞'}
                        </div>
                    </div>
                    
                    <div class="mt-3 flex gap-2">
                        <input type="number" id="contrib-${p.id}" placeholder="Montant" step="0.01" 
                               class="flex-1 p-2 rounded bg-white/20 text-white placeholder-white/70">
                        <button onclick="ajouterContributionParticipant('${p.id}', document.getElementById('contrib-${p.id}').value); document.getElementById('contrib-${p.id}').value=''" 
                                class="px-4 py-2 bg-green-500/80 rounded text-white hover:bg-green-600">
                            ‚ûï
                        </button>
                        <button onclick="retirerContributionParticipant('${p.id}', document.getElementById('contrib-${p.id}').value); document.getElementById('contrib-${p.id}').value=''" 
                                class="px-4 py-2 bg-red-500/80 rounded text-white hover:bg-red-600">
                            ‚ûñ
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function afficherHistoriqueTransactions() {
            const container = document.getElementById('historiqueTransactions');
            if (!container) return;
            
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Aucune transaction pour le moment.</p>';
                return;
            }
            
            const transactionsRecentes = transactions.slice(0, 10);
            
            container.innerHTML = transactionsRecentes.map(t => {
                const typeIcon = {
                    'contribution': 'üí∞',
                    'depense': 'üí∏',
                    'retrait': '‚ùå'
                }[t.type] || 'üí∏';
                
                const typeColor = {
                    'contribution': 'text-green-600',
                    'depense': 'text-red-600',
                    'retrait': 'text-orange-600'
                }[t.type] || 'text-red-600';
                
                return `
                    <div class="border-b border-gray-200 pb-2 mb-2">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <span class="text-lg">${typeIcon}</span>
                                <span class="font-medium">${t.description}</span>
                                ${t.participant ? `<br><small class="text-gray-500">par ${t.participant}</small>` : ''}
                            </div>
                            <span class="font-bold ${typeColor}">
                                ${t.type === 'contribution' ? '+' : '-'}${t.montant.toFixed(2)}‚Ç¨
                            </span>
                        </div>
                        <small class="text-gray-500">${t.date} √† ${t.heure}</small>
                    </div>
                `;
            }).join('');
        }

        function afficherPreparations() {
            const container = document.getElementById('preparationsJour');
            if (!container) return;
            
            if (preparations.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Aucune pr√©paration pour le moment.</p>';
                return;
            }
            
            // Grouper par jour
            const preparationsParJour = {};
            preparations.forEach(prep => {
                if (!preparationsParJour[prep.date]) {
                    preparationsParJour[prep.date] = [];
                }
                preparationsParJour[prep.date].push(prep);
            });
            
            const jours = Object.keys(preparationsParJour).sort().reverse().slice(0, 5);
            
            container.innerHTML = jours.map(jour => {
                const prepsJour = preparationsParJour[jour];
                return `
                    <div class="mb-3">
                        <h5 class="font-semibold text-gray-800">${jour} (${prepsJour.length} caf√©${prepsJour.length > 1 ? 's' : ''})</h5>
                        <div class="text-sm text-gray-600">
                            ${prepsJour.slice(-3).map(p => `${p.heure} - ${p.preparateur}`).join(' ‚Ä¢ ')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function afficherStock() {
            const cafeElement = document.getElementById('stockCafe');
            const filtresElement = document.getElementById('stockFiltres');
            
            if (cafeElement) cafeElement.textContent = stock.cafe || 0;
            if (filtresElement) filtresElement.textContent = stock.filtres || 0;
        }

        function mettreAJourSelecteurPreparateur() {
            const selecteur = document.getElementById('preparateurSelect');
            if (!selecteur) return;
            
            selecteur.innerHTML = '<option value="">Qui a pr√©par√© le caf√© ?</option>' +
                participants.map(p => `<option value="${p.nom}">${p.nom}</option>`).join('');
        }

        // === √âCOUTE EN TEMPS R√âEL ===
        function configurerEcouteTempsReel() {
            // √âcouter les participants (avec filtre)
            onSnapshot(collection(db, 'participants'), (snapshot) => {
                participants = snapshot.docs
                    .map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            totalContribue: data.totalContribue || 0,
                            preparationsCompte: data.preparationsCompte || 0,
                            contributions: data.contributions || []
                        };
                    })
                    .filter(p => p.nom && p.nom !== 'undefined' && p.nom.trim() !== ''); // Filtrer les donn√©es invalides
                mettreAJourInterface();
            });

            // √âcouter les transactions
            onSnapshot(query(collection(db, 'transactions'), orderBy('timestamp', 'desc')), (snapshot) => {
                transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                mettreAJourInterface();
            });

            // √âcouter les pr√©parations
            onSnapshot(query(collection(db, 'preparations'), orderBy('timestamp', 'desc')), (snapshot) => {
                preparations = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                mettreAJourInterface();
            });

            // √âcouter le stock
            onSnapshot(collection(db, 'stock'), (snapshot) => {
                if (!snapshot.empty) {
                    stock = snapshot.docs[0].data();
                    afficherStock();
                }
            });
        }

        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚òï Initialisation de la cagnotte du caf√©...');
            chargerDonnees().then(() => {
                configurerEcouteTempsReel();
                console.log('‚úÖ Cagnotte du caf√© charg√©e avec synchronisation temps r√©el !');
            });
        });
    </script>
</body>
</html>
